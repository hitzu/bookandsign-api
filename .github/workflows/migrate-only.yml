# ===================================================================================
# file: .github/workflows/migrate-only.yml
# Workflow mínimo para PROBAR que Supabase corre las migraciones con TypeORM
# Ejecuta: build → migration:run contra la DB de Supabase usando service_role
# ===================================================================================
name: migrate-only
on:
  workflow_dispatch: {} # lo lanzas manualmente
  # Si quieres probar en cada push a una rama específica, descomenta:
  # push:
  #   branches: [ try/migrations ]

jobs:
  run-migrations:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npm run build
      - name: Run TypeORM migrations on Supabase
        env:
          # WARNING: service_role solo en CI (permite DDL); NUNCA en runtime
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: npm run db:run:ci
